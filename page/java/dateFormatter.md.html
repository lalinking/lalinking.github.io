<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta name="keywords" content="java,DateFormat">
	<meta name="description" content="预先注册可能用到的日期格式，之后可通过传入的字符串特征自动转换成 Date 对象，而不需要另外指定格式。">
	<meta name="author" content="lalinking">
	<meta name="copyright" content="lalinking">
	<link href="/resource/main.css" type="text/css" rel="stylesheet">
	<link href="/resource/md.css" type="text/css" rel="stylesheet">
	<link href="/3rd-lib/gitalk/gitalk.css" type="text/css" rel="stylesheet">
	<link href="/3rd-lib/prism/prism.css" type="text/css" rel="stylesheet">
	<title>打工姿态 -> 学习姿态</title>
</head>
<body>
<noscript>## 功能

动态地将 String 转换为 Date 对象。

## 使用

```java
// 先注册一些可能用到的日期 DateFormat
DateStrParser.regestDateParser("yyyy-MM-dd");
DateStrParser.regestDateParser("yyyyMMdd");

// 调用 DateFormat，得到 Date 对象
Date date1 = DateStrParser.parseToDate("2018-11-09");
Date date2 = DateStrParser.parseToDate("20181109");

```

## 原理

### 注册 DateFormat

* 根据传入字符串 pattern，生成一个 SimpleDateFormat 放入 一个 Map 中。

* Map 的 key: pattern 中 表示一个数字的 GyYMLwWDdFEuaHkKhmsS 等用于格式化的特殊字母全部替换为 0 后得到的字符串。传入 "yyyy-MM-dd"，则 key 为 "0000-00-00"；传入 "yyyyMMdd" 则 key 为 "00000000".



### 解析字符串

* 先将传入的 dateStr 中所有数字都替换为 0 得到能获取对应 SimpleDateFormat 的 key。传入 "2018-11-09" 得到 "0000-00-00"；传入 "20181109" 得到 "00000000"。

* 根据 key 从 Map 中获取 SimpleDateFormat 进行转化。

## 源码

```java
package com.ricbbs.core;


import lombok.SneakyThrows;
import org.springframework.util.Assert;
import org.springframework.util.StringUtils;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * 字符串 => java.util.Date 转换工具类
 */
public final class DateUtil {

    public static String DATE_FORMAT = "yyyy-MM-dd";

    public static String DATETIME_FORMAT = "yyyy-MM-dd HH:mm:ss";

    public static String TIME_FORMAT = "HH:mm:ss";

    /**
     * key: GyYMLwWDdFEuaHkKhmsS 等用于格式化的特殊字母全部替换为 0 <br>
     * 传入实际字符串查找对应转换器的时候需要将实际字符串的数字全替换为0
     */
    private static final Map<String, String> dateFormatMap = new ConcurrentHashMap<>();

    /*
     * 以下为内置的可解析日期 pattern
     */
    static {

        // 年月日
        regestDateParser("yyyy-MM-dd");
        regestDateParser("yyyyMMdd");

        // 时分秒
        regestDateParser("HH:mm:ss");
        regestDateParser("HHmmss");
        regestDateParser("HH:mm:ss.SSS");
        regestDateParser("HHmmssSSS");

        // 完整时间戳
        regestDateParser("yyyy-MM-dd HH:mm:ss");
        regestDateParser("yyyyMMddHHmmss");
        regestDateParser("yyyy-MM-dd HH:mm:ss.SSS");
        regestDateParser("yyyyMMddHHmmssSSS");
        regestDateParser("yyyy-MM-dd'T'HH:mm:ss");

        // 完整时间戳带时区
        regestDateParser("yyyy-MM-dd'T'HH:mm:ssX");
        regestDateParser("yyyy-MM-dd'T'HH:mm:ss.SSSX");
    }

    /**
     * 不可实例化
     */
    private DateUtil() {
    }

    /**
     * 设置一个日期转换器
     *
     * @param pattern 已包含：<br>
     *                yyyy-MM-dd <br>
     *                yyyyMMdd <br>
     *                HH:mm:ss <br>
     *                HHmmss <br>
     *                HH:mm:ss.SSS <br>
     *                HHmmssSSS <br>
     *                yyyy-MM-dd HH:mm:ss <br>
     *                yyyyMMddHHmmss <br>
     *                yyyy-MM-dd HH:mm:ss.SSS <br>
     *                yyyyMMddHHmmssSSS <br>
     *                yyyy-MM-dd'T'HH:mm:ss <br>
     *                yyyy-MM-dd'T'HH:mm:ssX <br>
     *                yyyy-MM-dd'T'HH:mm:ss.SSSX <br>
     * @author Ric
     */
    public static void regestDateParser(String pattern) {
        Assert.hasText(pattern, "pattern can't be null.");
        if (pattern.contains("X")) {
            regestDateParser(pattern, pattern.replace("X", "+00:00"));
            regestDateParser(pattern, pattern.replace("X", "-00:00"));
            regestDateParser(pattern, pattern.replace("X", "'Z'"));
        } else {
            regestDateParser(pattern, pattern);
        }
    }

    /**
     * 转化为字符串日期
     *
     * @param format 格式
     * @param date   日期
     * @return new SimpleDateFormat(format).format(date)
     */
    public static String parse(String format, Date date) {
        if (!StringUtils.hasText(format) || date == null) {
            return "";
        } else {
            return new SimpleDateFormat(format).format(date);
        }
    }

    /**
     * 将日期转化为字符串 YYYY-MM-DD
     *
     * @param date 专辑ReleaseDate
     * @return new SimpleDateFormat(format).format(date)
     */
    public static String parseDate(Date date) {
        return parse(DATE_FORMAT, date);
    }

    /**
     * 将时间化为字符串 YYYY-MM-DD hh:mm:ss
     *
     * @param date 专辑ReleaseDate
     * @return new SimpleDateFormat(format).format(date)
     */
    public static String parseDateTime(Date date) {
        return parse(DATETIME_FORMAT, date);
    }

    /**
     * 将时间化为字符串 HH:mm:ss
     *
     * @param date 专辑ReleaseDate
     * @return new SimpleDateFormat(format).format(date)
     */
    public static String parseTime(Date date) {
        return parse(TIME_FORMAT, date);
    }

    /**
     * 解析字符串
     *
     * @return java.util.Date
     * @author Ric
     */
    @SneakyThrows
    public static Date parseToDate(String dateStr) {
        String key = dateStr.replaceAll("\\d", "0");
        String format = dateFormatMap.get(key);
        Assert.notNull(format, "can't find format for this date string: " + dateStr);
        return new SimpleDateFormat(format).parse(dateStr);
    }

    private static void regestDateParser(String pattern, String example) {
        String[] split = example.split("'");
        boolean s = false;
        StringBuilder key = new StringBuilder();
        for (String string : split) {
            if (s) {
                key.append(string);
            } else {
                key.append(string.replaceAll("[GyYMLwWDdFEuaHkKhmsS]", "0"));
            }
            s = !s;
        }
        dateFormatMap.put(key.toString(), pattern);
    }

}
```
</noscript>
<div id="header"></div>
<div id="main">
	<div id="board" class="curb">
		<div class="face front">
			<div id="bookshelf"><div id="bookshelf_left"></div><div id="bookshelf_inner"></div><div id="bookshelf_right"></div></div>
			<div class="talk" data-click="talk_switch" tabindex="1"><i class="icon close" data-click="talk_close"></i><div id="talk"></div></div>
		</div>
		<div class="face back"></div>
	</div>
	<div id="tools">
		<div class='icon index_close' data-click='index_close' title="回到桌面"></div>
	</div>
</div>
<div id="foot"></div>
</body>
<script src="/resource/upgrade.js"></script>
<script src="/resource/pageInit.js"></script>
<script>
	initBookShelf('{"maxThickness":4,"maxHeight":10,"P35186368":{"BookId":"P35186368","BookName":"课外题","contents":[{"FileTitle":"demo","BookName":"课外题","Date":"2019-12-19","Description":"一个博文的demo","Keywords":"demo,markdown","FilePath":"demo.md"},{"FileTitle":"magnet 魔链增加 tracker","Date":"2019-10-08","Description":"magnet 魔链增加 tracker，更新服务器信息，获取更快的下载速度","Keywords":"magnet,tracker","FilePath":"/page/magnet/mag.html"},{"FileTitle":"图片转字符画","Date":"2019-10-08","Description":"图片转字符画","Keywords":"图片,字符画","FilePath":"/page/pic/pic.html"},{"FileTitle":"图灵机器人实用","Date":"2015-10-12","Description":"调用图灵机器人的api实现自动聊天","Keywords":"图灵机器人","FilePath":"/page/wx_yuki/wx.html"}]},"M-154268230":{"BookId":"M-154268230","BookName":"Java 笔记","contents":[{"FileTitle":"Spring-Cloud 微服务学习日志","BookName":"Java 笔记","Date":"2019-11-21","Description":"spring cloud 微服务配置与应用","Keywords":"java,spring cloud","FilePath":"java/spring-cloud.md"},{"FileTitle":"“自适应”的 String 转 Date 工具","BookName":"Java 笔记","Date":"2018-11-09","Description":"预先注册可能用到的日期格式，之后可通过传入的字符串特征自动转换成 Date 对象，而不需要另外指定格式。","Keywords":"java,DateFormat","FilePath":"java/dateFormatter.md"}]},"P665848904":{"BookId":"P665848904","BookName":"Web & Node","contents":[{"FileTitle":"Js 简单实现类与继承","BookName":"Web & Node","Date":"2019-05-27","Description":"JS 简单实现类与继承","Keywords":"js,class","FilePath":"web/js_class.md"},{"FileTitle":"NodeJs 简单实现“模板文件”","BookName":"Web & Node","Date":"2018-03-07","Description":"简单的字符串模板实现","Keywords":"node,template","FilePath":"web/nodejs_template.md"}]}}');
</script>
<script src="/3rd-lib/markedjs/marked.js"></script>
<script src="/3rd-lib/prism/prism.js"></script>
<script data-runat="init">
	console.log("fresh at: 2021-11-06T06:00:03.729Z");
	var mdContent = $("noscript")[0].innerText;
	if (mdContent.length) {
		$("#M-154268230").setAttribute("data-status", "post_loading");
		showPost("java/dateFormatter.md", "“自适应”的 String 转 Date 工具", "2018-11-09", mdContent);
	} else {
		initTalk("index.html", "首页");
	}
</script>
</html>